<!DOCTYPE html>

<html>
<head>
  <title>romantic.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>romantic.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h2 id="romantic-js">Romantic.js</h2>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>v0.0.1</p>
<p>Copyright (c)2013 Jake Craige
Distributed under MIT license</p>
<p><a href="http://jcraige.com">http://jcraige.com</a></p>
<p>More info in readme found at <a href="https://github.com/jakecraige/romantic">https://github.com/jakecraige/romantic</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="function"><span class="keyword">function</span><span class="params">(root, factory)</span> {</span>

  root.Romantic = factory(root, {}, root._);

}(<span class="keyword">this</span>, <span class="function"><span class="keyword">function</span><span class="params">(root, Romantic, _)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Borrowed from: <a href="https://github.com/jashkenas/underscore/issues/557">https://github.com/jashkenas/underscore/issues/557</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.mixin({
    deepIndex: <span class="function"><span class="keyword">function</span> <span class="params">(array, item)</span> {</span>
      <span class="keyword">var</span> result = -<span class="number">1</span>;
      _.some(array, <span class="function"><span class="keyword">function</span> <span class="params">(value, index)</span> {</span>
        <span class="keyword">if</span> (_.isEqual(value, item)) {
          result = index;
          <span class="keyword">return</span> <span class="literal">true</span>;
        }
      });
      <span class="keyword">return</span> result;
    }
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Create local references to array methods we&#39;ll want to use later.(Backbone)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> array = [];

  Romantic.VERSION = <span class="string">'0.0.1'</span>;

  Romantic.String = {
    capitalize: <span class="function"><span class="keyword">function</span><span class="params">(str)</span> {</span>
      <span class="keyword">return</span> str.substr(<span class="number">0</span>,<span class="number">1</span>).toUpperCase() + str.substr(<span class="number">1</span>);
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="localforage-adapter-constructor">LocalForage Adapter Constructor</h2>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> LocalForage = Romantic.LocalForage = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
    <span class="keyword">this</span>.initialize.apply(<span class="keyword">this</span>, arguments);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2 id="localforage-adapter-methods">LocalForage Adapter Methods</h2>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Guid generation borrowed from
<a href="http://documentup.com/jeromegn/backbone.localStorage">http://documentup.com/jeromegn/backbone.localStorage</a>
Generate four random hex digits.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="keyword">function</span> <span class="title">S4</span><span class="params">()</span> {</span>
    <span class="keyword">return</span> (((<span class="number">1</span>+Math.random())*<span class="number">0x10000</span>)|<span class="number">0</span>).toString(<span class="number">16</span>).substring(<span class="number">1</span>);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Generate a pseudo-GUID by concatenating random hexadecimal.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="keyword">function</span> <span class="title">guid</span><span class="params">()</span> {</span>
    <span class="keyword">return</span> (S4()+S4()+<span class="string">"-"</span>+S4()+<span class="string">"-"</span>+S4()+<span class="string">"-"</span>+S4()+<span class="string">"-"</span>+S4()+S4()+S4());
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Adapter API</p>
<ul>
<li>replace</li>
<li>batch</li>
<li>keys</li>
<li>set</li>
<li>get</li>
<li>destroy</li>
<li>all</li>
<li>exists</li>
<li>destroyAll</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.extend(LocalForage.prototype, {
    initialize: <span class="function"><span class="keyword">function</span><span class="params">(options)</span> {</span>
      <span class="keyword">this</span>.dbName = options.dbName;
      <span class="keyword">this</span>.tableName = options.tableName;
      <span class="keyword">this</span>.setup();
      <span class="keyword">return</span> <span class="keyword">this</span>;
    },

    setup: <span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
      <span class="keyword">this</span>.setupDatabase();
      <span class="keyword">this</span>.setupTable(callback);
    },

    setupDatabase: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
      <span class="keyword">this</span>.database = <span class="literal">null</span>;
      <span class="keyword">this</span>.database = <span class="keyword">new</span> Romantic.LocalForage.DB(<span class="keyword">this</span>.dbName);
    },

    setupTable: <span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
      <span class="keyword">var</span> that = <span class="keyword">this</span>;
      <span class="keyword">if</span>(!_.include(<span class="keyword">this</span>.tables(), <span class="keyword">this</span>.tableName)) {
        <span class="keyword">this</span>.table = [];
        <span class="keyword">this</span>.setTable([]);
        <span class="keyword">if</span>(callback) {
          callback([]);
        }
      } <span class="keyword">else</span> {
        <span class="keyword">this</span>.database.get(<span class="keyword">this</span>.tableName, <span class="function"><span class="keyword">function</span><span class="params">(data)</span>{</span>
          that.table = data;
          <span class="keyword">if</span>(callback) {
            callback(_.clone(data));
          }
        });
      }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Replaces the table with the array of objects passed in</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    replace: <span class="function"><span class="keyword">function</span><span class="params">(newTable, callback)</span> {</span>
      <span class="keyword">if</span>(newTable == <span class="literal">null</span>) { newTable = <span class="keyword">this</span>.table; }
      <span class="keyword">return</span> <span class="keyword">this</span>.setTable(newTable, callback);
    },

    setTable: <span class="function"><span class="keyword">function</span><span class="params">(data, callback)</span> {</span>
      <span class="keyword">var</span> that = <span class="keyword">this</span>;
      <span class="keyword">if</span>(_.isArray(data)) {
        <span class="keyword">this</span>.database.set(<span class="keyword">this</span>.tableName, data, <span class="function"><span class="keyword">function</span><span class="params">(newData)</span>{</span>
          that.table = newData;
          <span class="keyword">if</span>(callback) {
            callback(newData);
          }
        });
      } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>If this function called without any data we are trying to reset the
database to the local copy</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.setup(callback)
      }
      <span class="keyword">return</span> <span class="keyword">this</span>.table;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Returns a list of all the tables in the database</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    tables: <span class="function"><span class="keyword">function</span><span class="params">(tableName)</span> {</span>
      <span class="keyword">return</span> <span class="keyword">this</span>.database.tables();
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Removes the table completely from the database</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    destroyAll: <span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
      <span class="keyword">var</span> that = <span class="keyword">this</span>;
      <span class="keyword">return</span> <span class="keyword">this</span>.database.destroy(<span class="keyword">this</span>.tableName, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        that.setup(callback);
      });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Returns the table, an array of objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    all: <span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
      <span class="keyword">return</span> callback(_.clone(<span class="keyword">this</span>.table));
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>When passed in an object/string/num it will pull out the id or cid and
find that in the table and return the found object, the id will always
take precedence</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    find: <span class="function"><span class="keyword">function</span><span class="params">(data, callback)</span> {</span>
      <span class="keyword">var</span> _this, id, cid, match, isValidId;
      id = data;

      <span class="keyword">if</span>(_.isObject(data) &amp;&amp; !_.isArray(data)) {
        id = data.id;
        cid = data.cid;
      }

      isValidId = <span class="function"><span class="keyword">function</span><span class="params">(id)</span> {</span>
        <span class="keyword">if</span>(_.isNumber(id) &amp;&amp; id &gt;= <span class="number">0</span>) {
          <span class="keyword">return</span> <span class="literal">true</span>;
        } <span class="keyword">else</span> <span class="keyword">if</span>(_.isString(id)) {
          <span class="keyword">return</span> <span class="literal">true</span>;
        }
      };

      <span class="keyword">if</span>((id || id === <span class="number">0</span>) &amp;&amp; !isValidId(id)) {
        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'id: '</span> + id + <span class="string">' is not a valid id'</span>);
      } <span class="keyword">else</span> <span class="keyword">if</span>((cid || cid === <span class="number">0</span>) &amp;&amp; !isValidId(cid)) {
        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'cid: '</span> + cid + <span class="string">' is not a valid id'</span>);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Used to find matches in the table. Purposely using lazy == so that
there aren&#39;t issues with an id being a string like &quot;123&quot; and not
matching 124</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      _this = <span class="keyword">this</span>;
      lazyFindMatch = <span class="function"><span class="keyword">function</span><span class="params">(key, val)</span> {</span>
        <span class="keyword">return</span> _.find(_this.table, <span class="function"><span class="keyword">function</span><span class="params">(row)</span>{</span>
          <span class="keyword">if</span>(row[key] == val) {
            <span class="keyword">return</span> <span class="literal">true</span>;
          }
        });
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Loop through table to find the first match. It starts by trying to find
one by id and if it can&#39;t, it falls back to looking by cid
TODO: this could definitely be refactored</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span>(id || id === <span class="number">0</span>) {
        match = lazyFindMatch(<span class="string">'id'</span>, id);
      }
      <span class="keyword">if</span>(!match) {
        <span class="keyword">if</span>(cid || cid === <span class="number">0</span>) {
          match = lazyFindMatch(<span class="string">'cid'</span>, cid);
        }
        <span class="keyword">if</span> (!match &amp;&amp; id ) {
          match =  lazyFindMatch(<span class="string">'cid'</span>, id);
        }
      }
      <span class="keyword">return</span> callback(_.clone(match));
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Pass in an object that will be given a unique cid, pushed onto the table,
and saved
Returns the new object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    create: <span class="function"><span class="keyword">function</span><span class="params">(data, callback)</span> {</span>
      <span class="keyword">var</span> table;
      data.cid = guid();
      <span class="keyword">this</span>.table.push(data);
      table = <span class="keyword">this</span>.table

      <span class="keyword">return</span> <span class="keyword">this</span>.replace(table, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        callback(_.clone(data));
      });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Pass in an object that will be updated and saved
Returns the modified object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    update: <span class="function"><span class="keyword">function</span><span class="params">(data, callback)</span> {</span>
      <span class="keyword">var</span> row, index, that = <span class="keyword">this</span>;
      <span class="keyword">return</span> <span class="keyword">this</span>.find(data, <span class="function"><span class="keyword">function</span><span class="params">(row)</span>{</span>
        index = _.deepIndex(that.table, row);
        <span class="keyword">if</span>(!row) {
          <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Couldnt find record with that id or cid'</span>);
        }
        row = _.extend(row, data);
        that.table[index] = row;
        that.replace(that.table, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
          <span class="keyword">return</span> callback(_.clone(row));
        });
      });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Pass in an object/id that will be destroyed and saved on the table
Returns the deleted row</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    destroy: <span class="function"><span class="keyword">function</span><span class="params">(data, callback)</span> {</span>
      <span class="keyword">var</span> that = <span class="keyword">this</span>;
      <span class="keyword">return</span> <span class="keyword">this</span>.find(data, <span class="function"><span class="keyword">function</span><span class="params">(row)</span>{</span>
        <span class="keyword">var</span> index;
        <span class="keyword">if</span>(!row) { callback(<span class="literal">false</span>); <span class="keyword">return</span>; }
        index = _.deepIndex(that.table, row);
        <span class="keyword">if</span>(index !== <span class="literal">undefined</span>) {
          that.table.splice(index,<span class="number">1</span>);
        }
        that.replace(that.table, <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
          callback(_.clone(row));
        });
      });
    }
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h2 id="db-constructor">DB Constructor</h2>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> DB = Romantic.LocalForage.DB = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
    <span class="keyword">this</span>.initialize.apply(<span class="keyword">this</span>, arguments);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <h2 id="db-methods">DB Methods</h2>

            </div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  _.extend(DB.prototype, {
    initialize: <span class="function"><span class="keyword">function</span><span class="params">(dbName)</span> {</span>
      <span class="keyword">this</span>._dbName = dbName;
      <span class="keyword">this</span>.reload();
      <span class="keyword">return</span> <span class="keyword">this</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Sets up the local database. Called externally to reload the database
after it&#39;s been cleared</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    reload: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
      <span class="keyword">this</span>._database = localforage.namespace(<span class="keyword">this</span>._dbName);
      <span class="keyword">return</span> <span class="keyword">this</span>._database;
    },

    all: <span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
      <span class="keyword">var</span> that = <span class="keyword">this</span>;
      <span class="keyword">return</span> <span class="keyword">this</span>._database._getKeysCache(<span class="function"><span class="keyword">function</span><span class="params">(keys)</span>{</span>
        <span class="keyword">if</span>(callback &amp;&amp; !keys) { callback([]); }

        promises = keys.map(<span class="function"><span class="keyword">function</span><span class="params">(key)</span>{</span>
          that._database.get(key)
        });

        Promise.all(promises).then(<span class="function"><span class="keyword">function</span><span class="params">(results)</span>{</span>
          <span class="keyword">if</span>(callback) {
            callback(results)
          }
        })
      });
    },

    tables: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
      <span class="keyword">return</span> _.keys(<span class="keyword">this</span>.all());
    },

    get: <span class="function"><span class="keyword">function</span><span class="params">(tableName, callback)</span> {</span>
      <span class="keyword">return</span> <span class="keyword">this</span>._database.getItem(tableName, callback);
    },

    set: <span class="function"><span class="keyword">function</span><span class="params">(tableName, data, callback)</span> {</span>
      <span class="keyword">return</span> <span class="keyword">this</span>._database.setItem(tableName, data, callback);
    },

    destroy: <span class="function"><span class="keyword">function</span><span class="params">(tableName, callback)</span> {</span>
      <span class="keyword">return</span> <span class="keyword">this</span>._database.removeItem(tableName, callback);
    }

  });</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h2 id="table-constructor">Table Constructor</h2>

            </div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> Table = Romantic.Table = <span class="function"><span class="keyword">function</span><span class="params">(name, options)</span> {</span>
    <span class="keyword">this</span>.initialize.apply(<span class="keyword">this</span>, arguments);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h2 id="table-methods">Table Methods</h2>

            </div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  _.extend(Table.prototype, {</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>When initializing a table you pass in it&#39;s name and options. If you
create another adapter you can pass in an adapter to the options hash</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    initialize: <span class="function"><span class="keyword">function</span><span class="params">(tableName, options)</span> {</span>
      <span class="keyword">if</span>(!tableName &amp;&amp; !<span class="keyword">this</span>.tableName) {
        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'You must provide a table name when initializing a table'</span>);
      }
      options || (options = {});

      options = _.defaults(options, {
        dbName: <span class="string">'romantic'</span>
      });

      <span class="keyword">this</span>._setStore(tableName, options);
      <span class="keyword">return</span> <span class="keyword">this</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>This sets up the store instance inside the object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _setStore: <span class="function"><span class="keyword">function</span><span class="params">(tableName, options)</span> {</span>
      options.tableName = <span class="keyword">this</span>.tableName || tableName
      <span class="keyword">this</span>._store = <span class="keyword">this</span>.adapter ? <span class="keyword">new</span> <span class="keyword">this</span>.adapter(options) : <span class="keyword">new</span> Romantic.LocalForage(options);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Takes an optional table parameter(array of objects), this allows you to
completely replace the database with a new data set.</p>
<p>It is used internally after the create, update, destroy functions</p>
<p>Example:</p>
<pre><code>var cars = [{make: &#39;Chevrolet&#39;, cid: 1}, {make: &#39;Dodge&#39;, cid: 2}];
var carsTable = new Romantic.DB.Table(&#39;cars&#39;);
carsTable.replace(cars);</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    replace: <span class="function"><span class="keyword">function</span><span class="params">(table, callback)</span> {</span>
      <span class="keyword">this</span>._store.setTable(<span class="keyword">this</span>.filterData(table), callback);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Utility function to console.table out the table for easy debugging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    logTable: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
      console.table(<span class="keyword">this</span>._store.table);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Utility function to console.log out the table for easy debugging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    log: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
      console.log(<span class="keyword">this</span>._store.table);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Filters data to attributes specified in table <code>schema</code>.</p>
<p>It can be an array of keys:
    [&#39;firstName&#39;, &#39;lastName&#39;]</p>
<p>An object with the key as the name and value as a type or function
validation:
    {
      &#39;address&#39;:   &#39;string&#39;,
      &#39;age&#39;:       &#39;integer&#39;
      &#39;firstName&#39;: function(name) {
        if(name === &#39;John&#39;) {
          return true;
        }
      }
    }</p>
<p>Accepted types are:</p>
<ul>
<li>Any</li>
<li>Array</li>
<li>Object</li>
<li>String</li>
<li>Number</li>
<li>Boolean</li>
<li><p>Custom function returning a boolean for if it&#39;s accepted or not</p>
<p>The object can be mixed with functions and type strings</p>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    filterData: <span class="function"><span class="keyword">function</span><span class="params">(data)</span> {</span>
      <span class="keyword">if</span>(<span class="keyword">this</span>.schema) {
        <span class="keyword">var</span> validKeys;</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>We start with the cid and id, they will always be permitted</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        validKeys = [<span class="string">'cid'</span>, <span class="string">'id'</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>The schema is only an array of keys, no validations will be done</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span>(_.isArray(<span class="keyword">this</span>.schema)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Add each value in the array as a valid key</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          _.each(<span class="keyword">this</span>.schema, <span class="function"><span class="keyword">function</span><span class="params">(column)</span>{</span>
            validKeys.push(column);
          });</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Schema is an object so we will need to specify validations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        } <span class="keyword">else</span> <span class="keyword">if</span>(_.isObject(<span class="keyword">this</span>.schema)) {

          _.each(<span class="keyword">this</span>.schema, <span class="function"><span class="keyword">function</span><span class="params">(val, key)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Accept any attribute if the value is &#39;&#39;
or
Accept attribute if value is a function that returns true when
given the attributes value in this object</p>
<p>TODO: Would it be better to use if/elseif here for some
reason? Instead of the ||</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span>(val === <span class="string">''</span> || _.isFunction(val) &amp;&amp; val(data[key])) {
              validKeys.push(key);
            } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Loop through accepted types and use underscores method to
verify that it is one of those types</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              acceptedTypes = [<span class="string">'array'</span>, <span class="string">'object'</span>, <span class="string">'string'</span>, <span class="string">'number'</span>, <span class="string">'boolean'</span>];
              _.each(acceptedTypes, <span class="function"><span class="keyword">function</span><span class="params">(type)</span> {</span>
                <span class="keyword">if</span>(val === type &amp;&amp; _[<span class="string">'is'</span>+Romantic.String.capitalize(type)](data[key])) {
                  validKeys.push(key);
                }
              });
            }

          });

        }</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Returns new object with only the keys from validKeys pulled out</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> _.pick(data, validKeys);
      }
      <span class="keyword">return</span> data;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Defers to current store&#39;s <code>create</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    create: <span class="function"><span class="keyword">function</span><span class="params">(data, callback)</span> {</span>
      <span class="keyword">return</span> <span class="keyword">this</span>._store.create(<span class="keyword">this</span>.filterData(data), callback);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Gets all data from current store via <code>all</code> and filters it and returns an
array of that data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    all: <span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
      <span class="keyword">var</span> that = <span class="keyword">this</span>;
      <span class="keyword">return</span> <span class="keyword">this</span>._store.all(<span class="function"><span class="keyword">function</span><span class="params">(data)</span> {</span>
        callback(_.map(data, <span class="function"><span class="keyword">function</span><span class="params">(row)</span> {</span>
          <span class="keyword">return</span> <span class="keyword">this</span>.filterData(row);
        }, that));
      });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Defers to the current store&#39;s <code>find</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    find: <span class="function"><span class="keyword">function</span><span class="params">(data, callback)</span> {</span>
      <span class="keyword">return</span> <span class="keyword">this</span>._store.find(data, callback);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Filters data via schema and defers to current store&#39;s <code>update</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    update: <span class="function"><span class="keyword">function</span><span class="params">(data, callback)</span> {</span>
      <span class="keyword">return</span> <span class="keyword">this</span>._store.update(<span class="keyword">this</span>.filterData(data), callback);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Defers to the current store&#39;s <code>deferAll</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    destroyAll: <span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
      <span class="keyword">return</span> <span class="keyword">this</span>._store.destroyAll(callback);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Defers to current store&#39;s <code>create</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    destroy: <span class="function"><span class="keyword">function</span><span class="params">(data, callback)</span> {</span>
      <span class="keyword">return</span> <span class="keyword">this</span>._store.destroy(data, callback);
    }

  });</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Code Borrowed From Backbone
<a href="http://backbonejs.org">http://backbonejs.org</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> methods = [<span class="string">'forEach'</span>, <span class="string">'each'</span>, <span class="string">'map'</span>, <span class="string">'collect'</span>, <span class="string">'reduce'</span>, <span class="string">'foldl'</span>,
    <span class="string">'inject'</span>, <span class="string">'reduceRight'</span>, <span class="string">'foldr'</span>, ,<span class="string">'detect'</span>, <span class="string">'filter'</span>, <span class="string">'select'</span>,
    <span class="string">'reject'</span>, <span class="string">'every'</span>, <span class="string">'some'</span>, <span class="string">'any'</span>, <span class="string">'include'</span>, <span class="string">'contains'</span>, <span class="string">'invoke'</span>,
    <span class="string">'max'</span>, <span class="string">'min'</span>, <span class="string">'toArray'</span>, <span class="string">'size'</span>, <span class="string">'first'</span>, <span class="string">'head'</span>, <span class="string">'take'</span>, <span class="string">'initial'</span>, <span class="string">'rest'</span>,
    <span class="string">'tail'</span>, <span class="string">'drop'</span>, <span class="string">'last'</span>, <span class="string">'without'</span>, <span class="string">'difference'</span>, <span class="string">'indexOf'</span>, <span class="string">'shuffle'</span>,
    <span class="string">'lastIndexOf'</span>, <span class="string">'isEmpty'</span>, <span class="string">'chain'</span>, <span class="string">'sample'</span>, <span class="string">'where'</span>, <span class="string">'findWhere'</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Mix in each Underscore method as a proxy to <code>Table#_table</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.each(methods, <span class="function"><span class="keyword">function</span><span class="params">(method)</span> {</span>
    Table.prototype[method] = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
      <span class="keyword">var</span> args = array.slice.call(arguments);
      args.unshift(<span class="keyword">this</span>._table);
      <span class="keyword">return</span> _[method].apply(_, args);
    };
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Underscore methods that take a property name as an argument.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> attributeMethods = [<span class="string">'groupBy'</span>, <span class="string">'countBy'</span>, <span class="string">'sortBy'</span>, <span class="string">'indexBy'</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Use attributes instead of properties.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.each(attributeMethods, <span class="function"><span class="keyword">function</span><span class="params">(method)</span> {</span>
    Table.prototype[method] = <span class="function"><span class="keyword">function</span><span class="params">(value, context)</span> {</span>
      <span class="keyword">var</span> iterator = _.isFunction(value) ? value : <span class="function"><span class="keyword">function</span><span class="params">(model)</span> {</span>
        <span class="keyword">return</span> model[value];
      };
      <span class="keyword">return</span> _[method](<span class="keyword">this</span>._table, iterator, context);
    };
  });

  <span class="keyword">var</span> extend = <span class="function"><span class="keyword">function</span><span class="params">(protoProps, staticProps)</span> {</span>
    <span class="keyword">var</span> parent = <span class="keyword">this</span>;
    <span class="keyword">var</span> child;</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>The constructor function for the new subclass is either defined by you
(the &quot;constructor&quot; property in your <code>extend</code> definition), or defaulted
by us to simply call the parent&#39;s constructor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (protoProps &amp;&amp; _.has(protoProps, <span class="string">'constructor'</span>)) {
      child = protoProps.constructor;
    } <span class="keyword">else</span> {
      child = <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span> <span class="keyword">return</span> parent.apply(<span class="keyword">this</span>, arguments); };
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Add static properties to the constructor function, if supplied.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.extend(child, parent, staticProps);</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Set the prototype chain to inherit from <code>parent</code>, without calling
<code>parent</code>&#39;s constructor function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> Surrogate = <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span> <span class="keyword">this</span>.constructor = child; };
    Surrogate.prototype = parent.prototype;
    child.prototype = <span class="keyword">new</span> Surrogate;</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Add prototype properties (instance properties) to the subclass,
if supplied.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (protoProps) _.extend(child.prototype, protoProps);</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Set a convenience property in case the parent&#39;s prototype is needed
later.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    child.__super__ = parent.prototype;

    <span class="keyword">return</span> child;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Set up inheritance for the Table</p>
<p>End of Code Borrowed From Backbone
<a href="http://backbonejs.org">http://backbonejs.org</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  DB.extend = LocalForage.extend = Table.extend = extend;

  <span class="keyword">return</span> Romantic;
}));</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
