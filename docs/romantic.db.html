<!DOCTYPE html>

<html>
<head>
  <title>romantic.db.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>romantic.db.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h2 id="by-jake-craige-2013">by Jake Craige 2013</h2>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p><em>TODO:</em></p>
<ul>
<li>Set up locator functions to accept an array</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="function"><span class="keyword">function</span><span class="params">(root, factory)</span> {</span>

  root.Romantic = factory(root, {}, root._);

}(<span class="keyword">this</span>, <span class="function"><span class="keyword">function</span><span class="params">(root, Romantic, _)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Create local references to array methods we&#39;ll want to use later.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> array = [];

  Romantic.VERSION = <span class="string">'0.0.1'</span>;

  <span class="keyword">var</span> Table = Romantic.Table = <span class="function"><span class="keyword">function</span><span class="params">(name, options)</span> {</span>
    <span class="keyword">this</span>.initialize.apply(<span class="keyword">this</span>, arguments);
  };

  _.extend(Table.prototype, {
    initialize: <span class="function"><span class="keyword">function</span><span class="params">(name, options)</span> {</span>
      options || (options = {});

      options = _.defaults(options, {
        dbName: <span class="string">'romantic'</span>
      });

      <span class="keyword">this</span>._setDatabase(options);
      <span class="keyword">this</span>._setTable(name);
      <span class="keyword">return</span> <span class="keyword">this</span>;
    },
    _setDatabase: <span class="function"><span class="keyword">function</span><span class="params">(options)</span> {</span>
      <span class="keyword">var</span> dbName;
      console.log(<span class="keyword">this</span>);
      <span class="keyword">if</span>(options.dbName) {
        dbName = options.dbName;
      } <span class="keyword">else</span> {
        dbName = <span class="string">'kaf'</span>
      }

      <span class="keyword">this</span>._database =  store.namespace(dbName);
    },
    _setTable: <span class="function"><span class="keyword">function</span><span class="params">(name)</span> {</span>
      <span class="keyword">this</span>._tableName = name;

      <span class="keyword">if</span>(!<span class="keyword">this</span>._database.has(name)) { <span class="keyword">this</span>._database(name, []); }

      <span class="keyword">this</span>._table = <span class="keyword">this</span>._database(name);
    },
    save: <span class="function"><span class="keyword">function</span><span class="params">(table)</span> {</span>
      <span class="keyword">if</span>(table == <span class="literal">null</span>) { table = <span class="keyword">this</span>._table; }
      <span class="keyword">this</span>._database(<span class="keyword">this</span>._tableName, table);
      <span class="keyword">return</span> table;
    },
    create: <span class="function"><span class="keyword">function</span><span class="params">(data)</span> {</span>
      data.cid = _.uniqueId(<span class="string">'c'</span>);
      <span class="keyword">this</span>._table.push(data);
      <span class="keyword">this</span>.save();
      <span class="keyword">return</span> data;
    },
    all: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
      <span class="keyword">return</span> <span class="keyword">this</span>._table;
    },
    find: <span class="function"><span class="keyword">function</span><span class="params">(data)</span> {</span>
      <span class="keyword">var</span> id;
      id = data;

      <span class="keyword">if</span>(data <span class="keyword">instanceof</span> Object) {
        id = data.id || data.cid;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Purposely using == and not === as to prevent type issues from coming
up when using localStorage as it could really be stored either way</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      match = _.find(<span class="keyword">this</span>._table, <span class="function"><span class="keyword">function</span><span class="params">(row)</span>{</span>
        <span class="keyword">return</span> row.id == id || row.cid == id
      });
      <span class="keyword">return</span> match;
    },
    update: <span class="function"><span class="keyword">function</span><span class="params">(data)</span> {</span>
      <span class="keyword">var</span> row, index;
      row   = <span class="keyword">this</span>.find(data);
      index = _.indexOf(<span class="keyword">this</span>._table, row);

      <span class="keyword">if</span>(!row) { <span class="keyword">return</span> <span class="literal">false</span>; }
      <span class="keyword">this</span>._table[index] = _.extend(row, data);
      <span class="keyword">this</span>.save();
      <span class="keyword">return</span> row;
    },
    destroyAll: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
      <span class="keyword">this</span>._database.remove(<span class="keyword">this</span>.tableName);
    },
    destroy: <span class="function"><span class="keyword">function</span><span class="params">(data)</span> {</span>
      <span class="keyword">var</span> row;
      row = <span class="keyword">this</span>.find(data);
      <span class="keyword">this</span>._table = _.without(<span class="keyword">this</span>._table, row);
      <span class="keyword">this</span>.save();
      <span class="keyword">return</span> row;
    }

  });</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Backbone, wooo!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> methods = [<span class="string">'forEach'</span>, <span class="string">'each'</span>, <span class="string">'map'</span>, <span class="string">'collect'</span>, <span class="string">'reduce'</span>, <span class="string">'foldl'</span>,
    <span class="string">'inject'</span>, <span class="string">'reduceRight'</span>, <span class="string">'foldr'</span>, ,<span class="string">'detect'</span>, <span class="string">'filter'</span>, <span class="string">'select'</span>,
    <span class="string">'reject'</span>, <span class="string">'every'</span>, <span class="string">'some'</span>, <span class="string">'any'</span>, <span class="string">'include'</span>, <span class="string">'contains'</span>, <span class="string">'invoke'</span>,
    <span class="string">'max'</span>, <span class="string">'min'</span>, <span class="string">'toArray'</span>, <span class="string">'size'</span>, <span class="string">'first'</span>, <span class="string">'head'</span>, <span class="string">'take'</span>, <span class="string">'initial'</span>, <span class="string">'rest'</span>,
    <span class="string">'tail'</span>, <span class="string">'drop'</span>, <span class="string">'last'</span>, <span class="string">'without'</span>, <span class="string">'difference'</span>, <span class="string">'indexOf'</span>, <span class="string">'shuffle'</span>,
    <span class="string">'lastIndexOf'</span>, <span class="string">'isEmpty'</span>, <span class="string">'chain'</span>, <span class="string">'sample'</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Mix in each Underscore method as a proxy to <code>Table#_table</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.each(methods, <span class="function"><span class="keyword">function</span><span class="params">(method)</span> {</span>
    Table.prototype[method] = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
      <span class="keyword">var</span> args = array.slice.call(arguments);
      args.unshift(<span class="keyword">this</span>._table);
      <span class="keyword">return</span> _[method].apply(_, args);
    };
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Underscore methods that take a property name as an argument.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> attributeMethods = [<span class="string">'groupBy'</span>, <span class="string">'countBy'</span>, <span class="string">'sortBy'</span>, <span class="string">'indexBy'</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Use attributes instead of properties.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.each(attributeMethods, <span class="function"><span class="keyword">function</span><span class="params">(method)</span> {</span>
    Table.prototype[method] = <span class="function"><span class="keyword">function</span><span class="params">(value, context)</span> {</span>
      <span class="keyword">var</span> iterator = _.isFunction(value) ? value : <span class="function"><span class="keyword">function</span><span class="params">(model)</span> {</span>
        <span class="keyword">return</span> model[value];
      };
      <span class="keyword">return</span> _[method](<span class="keyword">this</span>._table, iterator, context);
    };
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Thanks Backbone!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> extend = <span class="function"><span class="keyword">function</span><span class="params">(protoProps, staticProps)</span> {</span>
    <span class="keyword">var</span> parent = <span class="keyword">this</span>;
    <span class="keyword">var</span> child;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>The constructor function for the new subclass is either defined by you
(the &quot;constructor&quot; property in your <code>extend</code> definition), or defaulted
by us to simply call the parent&#39;s constructor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (protoProps &amp;&amp; _.has(protoProps, <span class="string">'constructor'</span>)) {
      child = protoProps.constructor;
    } <span class="keyword">else</span> {
      child = <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span> <span class="keyword">return</span> parent.apply(<span class="keyword">this</span>, arguments); };
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Add static properties to the constructor function, if supplied.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.extend(child, parent, staticProps);</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Set the prototype chain to inherit from <code>parent</code>, without calling
<code>parent</code>&#39;s constructor function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> Surrogate = <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span> <span class="keyword">this</span>.constructor = child; };
    Surrogate.prototype = parent.prototype;
    child.prototype = <span class="keyword">new</span> Surrogate;</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Add prototype properties (instance properties) to the subclass,
if supplied.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (protoProps) _.extend(child.prototype, protoProps);</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Set a convenience property in case the parent&#39;s prototype is needed
later.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    child.__super__ = parent.prototype;

    <span class="keyword">return</span> child;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Set up inheritance for the model, collection, router, view and history.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Table.extend = extend;

  <span class="keyword">return</span> Romantic;
}));</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
